<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Control Diario â€“ Dinamita POS (Full)</title>
<style>
:root{--red:#e11d48;--black:#0b0b0b;--muted:#4b5563}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;color:#111;background:#fff}
header{background:var(--black);color:#fff;padding:14px 16px;display:flex;align-items:center;gap:10px}
header h1{margin:0;font-size:16px;font-weight:800}
header small{color:#cbd5e1}
main{padding:16px;max-width:1000px;margin:0 auto}
.grid{display:grid;gap:12px}
.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.card{border:1px solid #eee;border-radius:14px;padding:14px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.04)}
label{font-size:12px;color:var(--muted);font-weight:600;display:block;margin-bottom:4px}
input,select,textarea{width:100%;padding:10px;border:1.5px solid #e5e7eb;border-radius:10px;background:#fff;font:inherit}
input[readonly]{background:#f6f7fb}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:13px}
th{background:#fafafa;font-weight:800}
.right{text-align:right}
.btn{border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
.btn.dark{background:#0b0b0b;color:#fff}
.btn.red{background:#e11d48;color:#fff}
.btn.gray{background:#e5e7eb}
.btn.outline{background:#fff;border:1.5px solid #111}
.thumb{width:46px;height:46px;border-radius:8px;border:1px solid #e5e7eb;object-fit:cover}
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;opacity:.95;display:none;z-index:50}
@media (max-width:820px){.cols-2,.row{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <h1>Control Diario â€“ Dinamita POS</h1>
  <small>Rango â€¢ Exportar/Importar â€¢ Backup â€¢ Fotos</small>
</header>
<main>
  <section class="grid cols-2">
    <div class="card">
      <h3 style="margin:0 0 8px 0">Registro del dÃ­a</h3>
      <div class="row">
        <div><label>Fecha ðŸ“†</label><input type="date" id="fecha"></div>
        <div>
          <label>Turno</label>
          <select id="turno">
            <option value="">Seleccionaâ€¦</option>
            <option value="1">Turno 1</option>
            <option value="2">Turno 2</option>
          </select>
        </div>
      </div>

      <h4 style="margin:12px 0 6px 0">Ventas</h4>
      <div class="row">
        <div><label>Tarjeta ($)</label><input type="number" id="v_tarjeta" min="0" step="0.01" value="0"></div>
        <div><label>Transferencia ($)</label><input type="number" id="v_transferencia" min="0" step="0.01" value="0"></div>
      </div>
      <div class="row">
        <div><label>CrÃ©dito ($)</label><input type="number" id="v_credito" min="0" step="0.01" value="0"></div>
        <div><label>Efectivo ($)</label><input type="number" id="v_efectivo" min="0" step="0.01" value="0"></div>
      </div>
      <div class="row">
        <div><label>Ventas Totales (auto)</label><input type="number" id="v_totales" value="0" readonly></div>
        <div><label>Venta del dÃ­a (auto)</label><input type="number" id="venta_dia" value="0" readonly></div>
      </div>

      <h4 style="margin:12px 0 6px 0">Gastos</h4>
      <div class="row">
        <div><label>Nombre del gasto</label><input id="g_nombre" placeholder="Ej. Productos de limpieza"></div>
        <div><label>Costo ($)</label><input type="number" id="g_costo" min="0" step="0.01" value="0"></div>
      </div>
      <div class="row">
        <div><label># Ticket (opcional)</label><input id="g_ticket" placeholder="9743146"></div>
        <div>
          <label>MÃ©todo de pago</label>
          <select id="g_metodo">
            <option value="">Seleccionaâ€¦</option>
            <option>Tarjeta</option><option>Efectivo</option><option>Transferencia</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>ðŸ“¸ Foto del ticket (cÃ¡mara/galerÃ­a)</label>
          <input id="g_foto" type="file" accept="image/*" capture="environment">
          <img id="g_preview" class="thumb" style="margin-top:6px;display:none" alt="preview">
        </div>
        <div style="display:flex;align-items:end;justify-content:flex-end">
          <button class="btn outline" id="btnAddGasto">Agregar gasto</button>
        </div>
      </div>

      <table id="tablaGastos">
        <thead><tr><th>Nombre</th><th class="right">Costo</th><th>MÃ©todo</th><th>Ticket</th><th>Foto</th><th></th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th class="right" colspan="6">Suma de gastos: <span id="sumaGastos">$0.00</span></th></tr></tfoot>
      </table>

      <div class="row" style="margin-top:8px">
        <div><label>Observaciones</label><input id="observaciones" placeholder="Notas del uso del dineroâ€¦"></div>
        <div style="display:flex;align-items:end;gap:8px;justify-content:flex-end">
          <button class="btn gray" id="btnLimpiar">Limpiar</button>
          <button class="btn red" id="btnGuardar">Guardar registro</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Reportes por rango</h3>
      <div class="row">
        <div><label>Desde</label><input type="date" id="f_ini"></div>
        <div><label>Hasta</label><input type="date" id="f_fin"></div>
      </div>
      <div class="row">
        <div><label>Turno (opcional)</label>
          <select id="f_turno"><option value="">Todos</option><option value="1">Turno 1</option><option value="2">Turno 2</option></select>
        </div>
        <div style="display:flex;align-items:end"><button class="btn outline" id="btnFiltrar">Aplicar filtro</button></div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin-top:8px">
        <div class="card" style="padding:10px"><div><b id="k_totales">$0.00</b><div style="font-size:12px;color:#6b7280">Ventas Totales</div></div></div>
        <div class="card" style="padding:10px"><div><b id="k_gastos">$0.00</b><div style="font-size:12px;color:#6b7280">Suma de Gastos</div></div></div>
        <div class="card" style="padding:10px"><div><b id="k_neto">$0.00</b><div style="font-size:12px;color:#6b7280">Venta del DÃ­a (Neto)</div></div></div>
      </div>

      <div class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px">
        <button class="btn dark" id="btnExportXLSX">Exportar Excel (.xlsx)</button>
        <button class="btn dark" id="btnExportCSV">Exportar CSV</button>
        <button class="btn dark" id="btnExportPDF">Exportar PDF</button>
        <label class="btn outline" for="importFile">Importar (Excel/CSV)</label>
        <input id="importFile" type="file" accept=".xlsx,.csv" style="display:none">
        <button class="btn gray" id="btnBackupExport">Backup (.zip)</button>
        <label class="btn outline" for="backupFile">Restaurar Backup</label>
        <input id="backupFile" type="file" accept=".zip" style="display:none">
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:14px">
    <h3 style="margin:0 0 8px 0">Registros guardados</h3>
    <div style="overflow:auto">
      <table id="tablaRegistros">
        <thead>
          <tr>
            <th>Fecha</th><th>Turno</th>
            <th class="right">Tarjeta</th><th class="right">Transf.</th><th class="right">CrÃ©dito</th>
            <th class="right">Efectivo</th><th class="right">Totales</th><th class="right">Gastos</th><th class="right">Venta DÃ­a</th>
            <th>Obs</th><th>Gastos (detalle)</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<div id="toast" class="toast">Guardado âœ…</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
const LS_KEY = 'control_diario_full_v1';
let REGISTROS = loadFromLS();
let gastosTemp = [];

const byId = id => document.getElementById(id);
const toNumber = v => isNaN(parseFloat(v)) ? 0 : parseFloat(v);
const fmt = n => '$' + (Number(n||0)).toLocaleString('es-MX',{minimumFractionDigits:2, maximumFractionDigits:2});

function saveToLS(){ localStorage.setItem(LS_KEY, JSON.stringify(REGISTROS)); }
function loadFromLS(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||[] }catch{ return [] } }
function uid(){ return 'id_' + Math.random().toString(36).slice(2,10); }
function toast(msg){ const t=byId('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1200); }

function calcTotals(){
  const t = toNumber(byId('v_tarjeta').value);
  const tr = toNumber(byId('v_transferencia').value);
  const c = toNumber(byId('v_credito').value);
  const ef = toNumber(byId('v_efectivo').value);
  const tot = t + tr + c + ef;
  byId('v_totales').value = tot.toFixed(2);
  const sumG = gastosTemp.reduce((a,g)=>a + toNumber(g.costo), 0);
  byId('sumaGastos').textContent = fmt(sumG);
  byId('venta_dia').value = (tot - sumG).toFixed(2);
}
['v_tarjeta','v_transferencia','v_credito','v_efectivo'].forEach(id=> byId(id).addEventListener('input', calcTotals));

// Foto preview + compresiÃ³n
byId('g_foto').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const dataUrl = await fileToDataURL(f, 0.8);
  const img = byId('g_preview'); img.src = dataUrl; img.style.display='block'; img.dataset.img = dataUrl;
});
function fileToDataURL(file, quality=0.8){
  return new Promise((resolve)=>{
    const reader = new FileReader();
    reader.onload = (ev)=>{
      const img = new Image();
      img.onload = ()=>{
        const max=1000; let w=img.width,h=img.height;
        if(w>h && w>max){ h=Math.round(h*max/w); w=max; } else if(h>max){ w=Math.round(w*max/h); h=max; }
        const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
        const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function renderGastos(){
  const tbody = byId('tablaGastos').querySelector('tbody');
  tbody.innerHTML = '';
  gastosTemp.forEach((g,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${g.nombre||''}</td>
      <td class="right">${fmt(g.costo)}</td>
      <td>${g.metodo_pago||''}</td>
      <td>${g.ticket||''}</td>
      <td>${g.imgData ? '<img class="thumb" src="'+g.imgData+'"/>' : 'â€”'}</td>
      <td class="right"><button class="btn gray" onclick="delGasto(${i})">Quitar</button></td>
    `;
    tbody.appendChild(tr);
  });
  const sumG = gastosTemp.reduce((a,g)=>a + toNumber(g.costo), 0);
  byId('sumaGastos').textContent = fmt(sumG);
  calcTotals();
}
function addGasto(){
  const nombre = byId('g_nombre').value.trim();
  const costo = toNumber(byId('g_costo').value);
  const ticket = byId('g_ticket').value.trim();
  const metodo_pago = byId('g_metodo').value;
  const imgData = byId('g_preview').dataset.img || '';
  if(!nombre){ alert('Nombre del gasto es obligatorio'); return }
  if(costo < 0){ alert('Costo no puede ser negativo'); return }
  if(!metodo_pago){ alert('Selecciona mÃ©todo de pago del gasto'); return }
  gastosTemp.push({ nombre, costo, ticket, metodo_pago, imgData });
  ['g_nombre','g_costo','g_ticket','g_metodo','g_foto'].forEach(id=>{ const el = byId(id); if(!el) return; el.value = (id==='g_costo'?'0':''); });
  byId('g_preview').src=''; byId('g_preview').style.display='none'; delete byId('g_preview').dataset.img;
  renderGastos();
}
function delGasto(i){ gastosTemp.splice(i,1); renderGastos(); }
byId('btnAddGasto').addEventListener('click', addGasto);

function clearForm(){
  ['fecha','turno','v_tarjeta','v_transferencia','v_credito','v_efectivo','v_totales','venta_dia','observaciones','g_nombre','g_costo','g_ticket','g_metodo','g_foto'].forEach(id=>{
    const el = byId(id); if(!el) return;
    if(el.type==='file'){ el.value=''; byId('g_preview').src=''; byId('g_preview').style.display='none'; delete byId('g_preview').dataset.img; return; }
    if(el.tagName==='SELECT') el.value=''; else if(el.hasAttribute('readonly')) el.value='0';
    else if(['v_tarjeta','v_transferencia','v_credito','v_efectivo','g_costo'].includes(id)) el.value='0'; else el.value='';
  });
  gastosTemp = []; renderGastos(); calcTotals(); byId('fecha').focus(); window.scrollTo({top:0,behavior:'smooth'});
}
byId('btnLimpiar').addEventListener('click', clearForm);

function guardar(){
  const btn = byId('btnGuardar'); btn.disabled = true;
  const fecha = byId('fecha').value; const turno = byId('turno').value;
  if(!fecha){ alert('Selecciona la fecha'); btn.disabled=false; return }
  if(!turno){ alert('Selecciona el turno'); btn.disabled=false; return }
  const ventas_tarjeta = toNumber(byId('v_tarjeta').value);
  const ventas_transferencia = toNumber(byId('v_transferencia').value);
  const ventas_credito = toNumber(byId('v_credito').value);
  const ventas_efectivo = toNumber(byId('v_efectivo').value);
  const ventas_totales = toNumber(byId('v_totales').value);
  const suma_gastos = gastosTemp.reduce((a,g)=>a + toNumber(g.costo), 0);
  const venta_del_dia = toNumber(byId('venta_dia').value);
  const observaciones = byId('observaciones').value.trim();

  const idx = REGISTROS.findIndex(r=> r.fecha===fecha && r.turno===turno);
  if(idx>-1){
    const ok = confirm('Ya existe un registro para esa fecha y turno. Â¿Actualizarlo?');
    if(!ok){ btn.disabled=false; return; }
  }
  const nuevo = {
    id: idx>-1 ? REGISTROS[idx].id : uid(),
    fecha, turno, ventas_tarjeta, ventas_transferencia, ventas_credito, ventas_efectivo,
    ventas_totales, suma_gastos, venta_del_dia, observaciones, gastos: JSON.parse(JSON.stringify(gastosTemp))
  };
  if(idx>-1){ REGISTROS[idx] = nuevo } else { REGISTROS.push(nuevo) }
  saveToLS(); renderRegistros(); toast('Registro guardado âœ…'); clearForm(); btn.disabled=false;
}
byId('btnGuardar').addEventListener('click', guardar);

function renderRegistros(lista = REGISTROS){
  const tbody = byId('tablaRegistros').querySelector('tbody');
  tbody.innerHTML='';
  lista.sort((a,b)=> (a.fecha+a.turno).localeCompare(b.fecha+b.turno));
  lista.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.fecha}</td><td>${r.turno}</td>
      <td class="right">${fmt(r.ventas_tarjeta)}</td>
      <td class="right">${fmt(r.ventas_transferencia)}</td>
      <td class="right">${fmt(r.ventas_credito)}</td>
      <td class="right">${fmt(r.ventas_efectivo)}</td>
      <td class="right">${fmt(r.ventas_totales)}</td>
      <td class="right">${fmt(r.suma_gastos)}</td>
      <td class="right">${fmt(r.venta_del_dia)}</td>
      <td>${(r.observaciones||'').slice(0,20)}</td>
      <td><button class="btn outline" onclick="verGastos('${r.id}')">Ver</button></td>
      <td class="right"><button class="btn gray" onclick="eliminar('${r.id}')">Eliminar</button></td>
    `;
    tbody.appendChild(tr);
  });
}
function verGastos(id){
  const r = REGISTROS.find(x=>x.id===id); if(!r) return;
  const lines = (r.gastos||[]).map((g,i)=>`${i+1}. ${g.nombre} â€¢ ${fmt(g.costo)} â€¢ ${g.metodo_pago}${g.ticket? ' â€¢ TKT:'+g.ticket:''}${g.imgData?' â€¢ ðŸ“·':''}`).join('\n');
  alert(lines || 'Sin gastos');
}
function eliminar(id){
  if(!confirm('Â¿Eliminar registro?')) return;
  REGISTROS = REGISTROS.filter(r=>r.id!==id); saveToLS(); renderRegistros();
}
function filtrar(){
  const ini = byId('f_ini').value || '0000-01-01';
  const fin = byId('f_fin').value || '9999-12-31';
  const turno = byId('f_turno').value;
  const L = REGISTROS.filter(r=> r.fecha>=ini && r.fecha<=fin && (turno? r.turno===turno : true));
  renderRegistros(L);
  const tot = L.reduce((a,r)=>a+ r.ventas_totales,0);
  const gas = L.reduce((a,r)=>a+ r.suma_gastos,0);
  const net = L.reduce((a,r)=>a+ r.venta_del_dia,0);
  byId('k_totales').textContent = fmt(tot);
  byId('k_gastos').textContent  = fmt(gas);
  byId('k_neto').textContent    = fmt(net);
  return L;
}
byId('btnFiltrar').addEventListener('click', filtrar);

// Exportaciones
function exportXLSX(){
  const L = filtrar();
  const control = L.map(r=>({
    fecha:r.fecha, turno:r.turno,
    ventas_tarjeta:r.ventas_tarjeta, ventas_transferencia:r.ventas_transferencia,
    ventas_credito:r.ventas_credito, ventas_efectivo:r.ventas_efectivo,
    ventas_totales:r.ventas_totales, suma_gastos:r.suma_gastos,
    venta_del_dia:r.venta_del_dia, observaciones:r.observaciones||''
  }));
  const gastos = [];
  L.forEach(r=> (r.gastos||[]).forEach((g,idx)=> gastos.push({
    fecha:r.fecha, turno:r.turno, nombre_gasto:g.nombre, costo:g.costo,
    metodo_pago:g.metodo_pago, ticket:g.ticket||'', foto:g.imgData ? 'sÃ­' : 'no'
  })));
  const wb = XLSX.utils.book_new();
  const ws1 = XLSX.utils.json_to_sheet(control);
  const ws2 = XLSX.utils.json_to_sheet(gastos);
  XLSX.utils.book_append_sheet(wb, ws1, 'Control Diario');
  XLSX.utils.book_append_sheet(wb, ws2, 'Gastos');
  const ini = byId('f_ini').value || 'todo'; const fin = byId('f_fin').value || 'todo';
  XLSX.writeFile(wb, `control_diario_${ini}_${fin}.xlsx`);
}
byId('btnExportXLSX').addEventListener('click', exportXLSX);

function toCSV(rows){
  if(!rows.length) return '';
  const headers = Object.keys(rows[0]);
  const esc = v => (v==null? '' : String(v).replaceAll('"','""'));
  const lines = [headers.join(',')];
  rows.forEach(r=> lines.push(headers.map(h=>`"${esc(r[h])}"`).join(',')));
  return lines.join('\n');
}
function exportCSV(){
  const L = filtrar();
  const control = L.map(r=>({
    fecha:r.fecha, turno:r.turno,
    ventas_tarjeta:r.ventas_tarjeta, ventas_transferencia:r.ventas_transferencia,
    ventas_credito:r.ventas_credito, ventas_efectivo:r.ventas_efectivo,
    ventas_totales:r.ventas_totales, suma_gastos:r.suma_gastos,
    venta_del_dia:r.venta_del_dia, observaciones:r.observaciones||''
  }));
  const gastos = [];
  L.forEach(r=> (r.gastos||[]).forEach(g=> gastos.push({
    fecha:r.fecha, turno:r.turno, nombre_gasto:g.nombre, costo:g.costo,
    metodo_pago:g.metodo_pago, ticket:g.ticket||'', foto:g.imgData ? 'sÃ­' : 'no'
  })));
  saveAs(new Blob([toCSV(control)], {type:'text/csv;charset=utf-8'}), 'control_diario.csv');
  saveAs(new Blob([toCSV(gastos)], {type:'text/csv;charset=utf-8'}), 'gastos.csv');
}
byId('btnExportCSV').addEventListener('click', exportCSV);

async function exportPDF(){
  const L = filtrar();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  const margin = 36, lineH = 16; let y = margin;
  const ini = byId('f_ini').value || 'Inicio'; const fin = byId('f_fin').value || 'Fin';
  doc.setFont('helvetica','bold'); doc.setFontSize(14);
  doc.text('Control Diario â€“ Dinamita POS', margin, y); y+=lineH;
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text(`Rango: ${ini} a ${fin}  |  Generado: ${new Date().toLocaleString('es-MX')}`, margin, y); y+=lineH*1.2;
  const tot = L.reduce((a,r)=>a+ r.ventas_totales,0);
  const gas = L.reduce((a,r)=>a+ r.suma_gastos,0);
  const net = L.reduce((a,r)=>a+ r.venta_del_dia,0);
  doc.text(`Ventas Totales: ${fmt(tot)}   |   Gastos: ${fmt(gas)}   |   Neto: ${fmt(net)}`, margin, y); y+=lineH*1.2;
  const headers = ['Fecha','T','Tarj','Transf','CrÃ©d','Efect','Tot','Gastos','Neto'];
  const widths = [70,20,60,60,60,60,60,60,60];
  y+=6; doc.setLineWidth(.5); doc.line(margin, y, 595-margin, y); y+=lineH;
  doc.setFont('helvetica','bold');
  headers.forEach((h,i)=> doc.text(h, margin + widths.slice(0,i).reduce((a,b)=>a+b,0), y));
  y+=lineH; doc.setFont('helvetica','normal');
  L.forEach(r=>{
    const row = [r.fecha, r.turno, r.ventas_tarjeta, r.ventas_transferencia, r.ventas_credito, r.ventas_efectivo, r.ventas_totales, r.suma_gastos, r.venta_del_dia];
    row.forEach((val,i)=>{
      const x = margin + widths.slice(0,i).reduce((a,b)=>a+b,0);
      doc.text(String(i<2? val : (fmt(val))), x, y);
    });
    y+=lineH; if(y>760){ doc.addPage(); y=margin }
  });
  y+=lineH; doc.setFont('helvetica','bold'); doc.text('Gastos del rango', margin, y); y+=lineH;
  doc.setFont('helvetica','bold');
  const gHeaders = ['Fecha','T','Gasto','MÃ©todo','Ticket','Costo','Foto'];
  const gW = [70,20,150,70,70,60,40];
  gHeaders.forEach((h,i)=> doc.text(h, margin + gW.slice(0,i).reduce((a,b)=>a+b,0), y));
  y+=lineH; doc.setFont('helvetica','normal');
  L.forEach(r=> (r.gastos||[]).forEach(g=>{
    const vals = [r.fecha, r.turno, g.nombre, g.metodo_pago||'', g.ticket||'', fmt(g.costo), g.imgData? 'ðŸ“·' : 'â€”'];
    vals.forEach((val,i)=>{
      const x = margin + gW.slice(0,i).reduce((a,b)=>a+b,0);
      doc.text(String(val), x, y);
    });
    y+=lineH; if(y>780){ doc.addPage(); y=margin }
  }));
  doc.save(`control_diario_${ini}_${fin}.pdf`);
}
byId('btnExportPDF').addEventListener('click', exportPDF);

// Importar
async function importFile(file){
  const ext = file.name.split('.').pop().toLowerCase();
  if(ext==='csv'){
    const text = await file.text();
    importCSV(text);
  } else if(ext==='xlsx'){
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data);
    const ws1 = wb.Sheets['Control Diario'] || wb.Sheets[wb.SheetNames[0]];
    const ws2 = wb.Sheets['Gastos'] || (wb.SheetNames[1] && wb.Sheets[wb.SheetNames[1]]) || null;
    const control = XLSX.utils.sheet_to_json(ws1||{});
    const gastos = XLSX.utils.sheet_to_json(ws2||[]);
    mergeImported(control, gastos);
  } else {
    alert('Formato no soportado');
  }
}
byId('importFile').addEventListener('change', (e)=>{ if(e.target.files[0]) importFile(e.target.files[0]); e.target.value=''});

function importCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const headers = lines[0].split(',').map(h=>h.replace(/^[\"']|[\"']$/g,''));
  const rows = lines.slice(1).map(l=>{
    const cols = l.match(/\"([^\"]*)\"|([^,]+)/g)?.map(c=>c.replace(/^\"|\"$/g,'')) || [];
    const obj = {}; headers.forEach((h,i)=> obj[h]=cols[i]);
    return obj;
  });
  mergeImported(rows, []);
}
function mergeImported(control, gastos){
  const map = new Map();
  REGISTROS.forEach(r=> map.set(r.fecha+'_'+r.turno, r));
  control.forEach(r=>{
    const fecha = String(r.fecha||'').slice(0,10);
    const turno = String(r.turno||'').trim();
    if(!fecha || !turno) return;
    const base = map.get(fecha+'_'+turno) || { id: uid(), fecha, turno, gastos: [] };
    base.ventas_tarjeta = toNumber(r.ventas_tarjeta);
    base.ventas_transferencia = toNumber(r.ventas_transferencia);
    base.ventas_credito = toNumber(r.ventas_credito);
    base.ventas_efectivo = toNumber(r.ventas_efectivo);
    const tot = base.ventas_tarjeta + base.ventas_transferencia + base.ventas_credito + base.ventas_efectivo;
    base.ventas_totales = tot;
    base.suma_gastos = toNumber(r.suma_gastos);
    base.venta_del_dia = tot - base.suma_gastos;
    base.observaciones = r.observaciones||'';
    map.set(fecha+'_'+turno, base);
  });
  gastos.forEach(g=>{
    const fecha = String(g.fecha||'').slice(0,10);
    const turno = String(g.turno||'').trim();
    if(!fecha || !turno) return;
    const base = map.get(feja+'_'+turno) || { id: uid(), fecha, turno, gastos: [] };
  });
  REGISTROS = Array.from(map.values());
  saveToLS(); renderRegistros(); alert('ImportaciÃ³n completada');
}

// Backup con imÃ¡genes
async function backupExport(){
  const zip = new JSZip();
  const meta = { version:'1.0', exported_at:new Date().toISOString() };
  zip.file('meta.json', JSON.stringify(meta, null, 2));
  zip.file('control_diario.json', JSON.stringify(REGISTROS.map(({gastos, ...r})=>r), null, 2));
  const gastos = [];
  for(const r of REGISTROS){
    (r.gastos||[]).forEach((g,idx)=>{
      const imgName = g.imgData ? `tickets/${r.fecha}_${r.turno}_${idx}.jpg` : '';
      gastos.push({ fecha:r.fecha, turno:r.turno, nombre:g.nombre, costo:g.costo, metodo_pago:g.metodo_pago, ticket:g.ticket||'', img: imgName });
      if(g.imgData){
        const b64 = g.imgData.split(',')[1];
        zip.file(imgName, b64, {base64:true});
      }
    });
  }
  zip.file('gastos.json', JSON.stringify(gastos, null, 2));
  const blob = await zip.generateAsync({type:'blob'});
  saveAs(blob, 'backup_control_diario.zip');
}
byId('btnBackupExport').addEventListener('click', backupExport);

async function backupImport(file){
  const zip = await JSZip.loadAsync(file);
  const control = JSON.parse(await zip.file('control_diario.json').async('string'));
  const gastos = JSON.parse(await zip.file('gastos.json').async('string'));
  const map = new Map();
  control.forEach(r=> map.set(r.fecha+'_'+r.turno, { id: uid(), ...r, gastos: [] }));
  for (const g of gastos){
    const key = g.fecha+'_'+g.turno;
    const base = map.get(key) || { id: uid(), fecha:g.fecha, turno:g.turno, gastos: [] };
    let imgData = '';
    if(g.img && zip.file(g.img)){
      const b64 = await zip.file(g.img).async('base64');
      imgData = 'data:image/jpeg;base64,' + b64;
    }
    base.gastos.push({ nombre:g.nombre, costo: toNumber(g.costo), metodo_pago:g.metodo_pago, ticket:g.ticket||'', imgData });
    map.set(key, base);
  }
  REGISTROS = Array.from(map.values()); saveToLS(); renderRegistros(); alert('Backup restaurado');
}
byId('backupFile').addEventListener('change', (e)=>{ if(e.target.files[0]) backupImport(e.target.files[0]); e.target.value=''});

renderRegistros(); calcTotals();
</script>
</body>
</html>
